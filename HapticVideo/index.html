<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Haptic Video Gallery</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:sans-serif;background:#111;color:#fff;}
    h1{padding:1rem;text-align:center;}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:1rem;padding:1rem;}
    .thumb{position:relative;cursor:pointer;border-radius:8px;overflow:hidden;border:2px solid #333;transition:transform .2s ease;}
    .thumb:hover{transform:scale(1.05);}
    .thumb img,.thumb video{width:100%;height:100%;object-fit:cover;display:block;}
    .thumb::after{content:'\25BA';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:3rem;color:#fff;text-shadow:0 0 10px #000;pointer-events:none;}
    video#player{position:fixed;top:0;left:0;width:100vw;height:100vh;object-fit:contain;background:#000;z-index:1000;display:none;}
  </style>
</head>
<body>
  <h1>Haptic Video Gallery</h1>
  <section id="grid"></section>
  <video id="player" controls playsinline></video>

  <script>
  // --- sample playlist -----------------------------------------------------
  const sampleVideos = [
    {
      title: "City Traffic 5s",
      url: "https://download.samplelib.com/mp4/sample-5s.mp4",
      thumb: "https://dummyimage.com/400x225/000/fff.png&text=Traffic+5s"
    },
    {
      title: "City Traffic 15s",
      url: "https://download.samplelib.com/mp4/sample-15s.mp4",
      thumb: "https://dummyimage.com/400x225/000/fff.png&text=Traffic+15s"
    },
    {
      title: "Big Buck Bunny (10 min)",
      url: "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
      thumb: "https://peach.blender.org/wp-content/uploads/title_anouncement.jpg"
    }
  ];

  // ------------------------------------------------------------------------
  const grid = document.getElementById('grid');
  const player = document.getElementById('player');
  let audioCtx, analyser, freqData;

  // build thumbnail grid ----------------------------------------------------
  sampleVideos.forEach(v => {
    const el = document.createElement('div');
    el.className = 'thumb';
    el.title = v.title;
    const img = document.createElement('img');
    img.src = v.thumb;
    img.alt = v.title;
    el.appendChild(img);
    el.addEventListener('click', () => playVideo(v.url));
    grid.appendChild(el);
  });

  // play selected video in fullscreen --------------------------------------
  async function playVideo(url){
    player.src = url;
    player.style.display = 'block';
    await player.play();
    if (player.requestFullscreen) {
      try { await player.requestFullscreen(); } catch(_){}
    }
    setupAudioAnalysis();
  }

  // hide player when done ---------------------------------------------------
  function cleanup(){
    player.style.display = 'none';
    if (document.fullscreenElement) document.exitFullscreen();
    if (audioCtx){
      audioCtx.close();
      audioCtx = null;
    }
  }
  player.addEventListener('pause', cleanup);
  player.addEventListener('ended', cleanup);

  // ------------------------------------------------------------------------
  // naive audio‑event detection -> haptic feedback
  // ------------------------------------------------------------------------
  function setupAudioAnalysis(){
    if (!('vibrate' in navigator)) return; // device has no haptics

    const AC = window.AudioContext || window.webkitAudioContext;
    if (!AC) return; // unsupported browser

    audioCtx = new AC();
    const src = audioCtx.createMediaElementSource(player);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    src.connect(analyser);
    analyser.connect(audioCtx.destination);

    freqData = new Uint8Array(analyser.frequencyBinCount);
    detect();
  }

  function f2i(freq,sampleRate,fftSize){
    return Math.round(freq / (sampleRate/fftSize));
  }

  function detect(){
    if (!analyser) return;
    analyser.getByteFrequencyData(freqData);

    const sr = audioCtx.sampleRate;
    const fft = analyser.fftSize;

    // car rev ~ 70–250 Hz, gunshot spike ~ 2–6 kHz
    const lowStart = f2i(70,sr,fft);
    const lowEnd   = f2i(250,sr,fft);
    const hiStart  = f2i(2000,sr,fft);
    const hiEnd    = f2i(6000,sr,fft);

    let lowEnergy=0, hiEnergy=0;
    for (let i=lowStart;i<=lowEnd;i++)   lowEnergy+=freqData[i];
    for (let i=hiStart;i<=hiEnd;i++)     hiEnergy+=freqData[i];
    lowEnergy/=(lowEnd-lowStart+1);
    hiEnergy/=(hiEnd-hiStart+1);

    const now = performance.now();
    // very simple thresholds – adjust per project
    if (hiEnergy>200 && (!detect.lastGun || now-detect.lastGun>1000)){
      navigator.vibrate([0,200,50,200]); // stronger pattern for gunshot
      detect.lastGun = now;
    }else if (lowEnergy>180 && (!detect.lastRev || now-detect.lastRev>600)){
      navigator.vibrate([0,100,30,100]); // shorter pattern for rev
      detect.lastRev = now;
    }

    if (!player.paused) requestAnimationFrame(detect);
  }
  </script>
</body>
</html>
